#
# user-defined-scalar-function-tests.yamsql
#
# This source file is part of the FoundationDB open source project
#
# Copyright 2021-2024 Apple Inc. and the FoundationDB project authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
schema_template:
    create type as struct st1(y bigint, z bigint)
    create type as struct st2(w bigint, x bigint)
    create type as struct st3(u st2, v st1)
    create type as struct st4(s bigint, t bigint)
    create table nested(id bigint, q st4, r st3, primary key(q.s, r.u.w))
    create index i2 as select r.v.z from nested order by r.v.z
    CREATE FUNCTION st2(IN x TYPE ST3) RETURNS ST2 AS x.u
    CREATE FUNCTION z(IN x TYPE ST3) RETURNS bigint AS x.v.z
    CREATE FUNCTION self(IN x bigint) RETURNS bigint AS x;
---
setup:
  steps:
    - query: INSERT INTO NESTED
        VALUES (1, (200, 1), ((5, 11), (10, 100))),
               (2, (201, 2), ((5, 12), (10, 100))),
               (3, (202, 3), ((5, 13), (10, 100))),
               (4, (203, 4), ((5, 14), (10, 100))),
               (5, (329, 5), ((5, 15), (10, 140))),
               (6, (330, 6), ((5, 16), (10, 140)))
---
test_block:
  name: user-defined-scalar-function-tests
  tests:
    -
      - query: select z(r) from nested group by z(r)
      - unorderedResult: [{100}, {140}]
    -
      - query: select st2(r) from nested
      - unorderedResult: [{{!l 5, !l 11}}, {{!l 5, !l 12}}, {{!l 5, !l 13}}, {{!l 5, !l 14}}, {{!l 5, !l 15}}, {{!l 5, !l 16}}]
    -
      - query: select id from nested where self(id) > 2 and self(id) < 5
      - unorderedResult: [{3}, {4}]
    -
      # wrong function name
      - query: select zz(r) from nested group by z(r)
      - error: "0AF00"
...
