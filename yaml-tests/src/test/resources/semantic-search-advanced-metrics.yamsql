#
# semantic-search-new-metrics.yamsql
#
# This source file is part of the FoundationDB open source project
#
# Copyright 2021-2025 Apple Inc. and the FoundationDB project authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
options:
  supported_version: !current_version
---
schema_template:
    create table documents(zone string, docId string, bookshelf string, title string, embedding vector(3, half), primary key (zone, docId))
    create view documentsView as select embedding, zone, bookshelf, docId, title from documents
    create vector index documentsEuclideanSquareIndex using hnsw on documentsView(embedding) partition by(zone, bookshelf) options (metric = euclidean_square_metric, rabitq_num_ex_bits = 3, use_rabitq = true)
    create vector index documentsDotProductIndex using hnsw on documentsView(embedding) partition by(zone, bookshelf) options (metric = dot_product_metric, rabitq_num_ex_bits = 3, use_rabitq = true)
    create table multiTypePartitionDocs(zoneId bigint, docId string, bookshelf string, title string, embedding vector(3, half), primary key (zoneId, docId))
    create view multiTypePartitionView as select embedding, zoneId, bookshelf, docId, title from multiTypePartitionDocs
    create vector index multiTypeEuclideanSquareIndex using hnsw on multiTypePartitionView(embedding) partition by(zoneId, bookshelf) options (metric = euclidean_square_metric)
    create vector index multiTypeDotProductIndex using hnsw on multiTypePartitionView(embedding) partition by(zoneId, bookshelf) options (metric = dot_product_metric)
---
test_block:
  preset: single_repetition_ordered
  options:
    statement_type: prepared
  name: semantic-search-new-metrics-tests
  tests:
    -
      - query:
          insert into documents values
          ('zone1', 'd1', 'fiction', 'The Great Gatsby', !! !v16 [1.0, 0.0, 0.0] !!),
          ('zone1', 'd2', 'fiction', '1984', !! !v16 [0.9, 0.1, 0.0] !!),
          ('zone1', 'd3', 'fiction', 'To Kill a Mockingbird', !! !v16 [0.8, 0.2, 0.0] !!),
          ('zone1', 'd4', 'fiction', 'Pride and Prejudice', !! !v16 [0.7, 0.3, 0.0] !!),
          ('zone1', 'd5', 'fiction', 'The Catcher in the Rye', !! !v16 [0.6, 0.4, 0.0] !!)
      - count: 5
    -
      - query:
          insert into documents values
          ('zone1', 'd6', 'science', 'A Brief History of Time', !! !v16 [0.0, 1.0, 0.0] !!),
          ('zone1', 'd7', 'science', 'The Selfish Gene', !! !v16 [0.1, 0.9, 0.0] !!),
          ('zone1', 'd8', 'science', 'Cosmos', !! !v16 [0.2, 0.8, 0.0] !!),
          ('zone1', 'd9', 'science', 'The Origin of Species', !! !v16 [0.3, 0.7, 0.0] !!),
          ('zone1', 'd10', 'science', 'Relativity', !! !v16 [0.4, 0.6, 0.0] !!)
      - count: 5
    -
      - query:
          insert into documents values
          ('zone2', 'd11', 'fiction', 'Moby Dick', !! !v16 [0.0, 0.0, 1.0] !!),
          ('zone2', 'd12', 'fiction', 'War and Peace', !! !v16 [0.0, 0.1, 0.9] !!),
          ('zone2', 'd13', 'fiction', 'Crime and Punishment', !! !v16 [0.0, 0.2, 0.8] !!),
          ('zone2', 'd14', 'science', 'The Gene', !! !v16 [0.5, 0.5, 0.0] !!),
          ('zone2', 'd15', 'science', 'Sapiens', !! !v16 [0.4, 0.4, 0.2] !!)
      - count: 5
# Test euclidean_square_distance metric
    -
      - query:
          select docId, title, euclidean_square_distance(embedding, !! !v16 [1.0, 0.0, 0.0] !!) from documents
          where zone = 'zone1' and bookshelf = 'fiction'
          qualify row_number() over (partition by zone, bookshelf order by euclidean_square_distance(embedding, !! !v16 [1.0, 0.0, 0.0] !!) asc) <= 1
      - explain: "ISCAN(DOCUMENTSEUCLIDEANSQUAREINDEX [EQUALS promote(@c17 AS STRING), EQUALS promote(@c21 AS STRING)]:{DISTANCE_RANK_LESS_THAN_OR_EQUAL @c39: @c45}:[] BY_DISTANCE) | MAP (_.DOCID AS DOCID, _.TITLE AS TITLE, (_.EMBEDDING) euclidean_square_distance @c39 AS _2)"
      - result: [{'d1', 'The Great Gatsby', 0.0}]
    -
      - query:
          select docId, euclidean_square_distance(embedding, !! !v16 [1.0, 0.0, 0.0] !!) from documents
          where zone = 'zone1' and bookshelf = 'fiction'
          qualify row_number() over (partition by zone, bookshelf order by euclidean_square_distance(embedding, !! !v16 [1.0, 0.0, 0.0] !!) asc) <= 3
      - explain: "ISCAN(DOCUMENTSEUCLIDEANSQUAREINDEX [EQUALS promote(@c15 AS STRING), EQUALS promote(@c19 AS STRING)]:{DISTANCE_RANK_LESS_THAN_OR_EQUAL @c37: @c43}:[] BY_DISTANCE) | MAP (_.DOCID AS DOCID, (_.EMBEDDING) euclidean_square_distance @c37 AS _1)"
      - result: [{'d1', 0.0}, {'d2', 0.020014658570289612}, {'d3', 0.08005863428115845}]
    -
      - query:
          select docId from documents
          where zone = 'zone1' and bookshelf = 'science'
          qualify row_number() over (partition by zone, bookshelf order by euclidean_square_distance(embedding, !! !v16 [0.0, 1.0, 0.0] !!) asc options ef_search = 100) <= 2
      - explain: "ISCAN(DOCUMENTSEUCLIDEANSQUAREINDEX [EQUALS promote(@c8 AS STRING), EQUALS promote(@c12 AS STRING)]:{DISTANCE_RANK_LESS_THAN_OR_EQUAL @c30: @c40}:[hnswEfSearch: 100] BY_DISTANCE) | MAP (_.DOCID AS DOCID)"
      - result: [{'d6'}, {'d7'}]
    -
      - query:
          select docId from documents
          where zone = 'zone1' and bookshelf = 'science'
          qualify row_number() over (partition by zone, bookshelf order by euclidean_square_distance(embedding, !! !v16 [0.0, 1.0, 0.0] !!) asc options ef_search = 200) < 3
      - explain: "ISCAN(DOCUMENTSEUCLIDEANSQUAREINDEX [EQUALS promote(@c8 AS STRING), EQUALS promote(@c12 AS STRING)]:{DISTANCE_RANK_LESS_THAN @c30: @c39}:[hnswEfSearch: 200] BY_DISTANCE) | MAP (_.DOCID AS DOCID)"
      - result: [{'d6'}, {'d7'}]
    -
      - query:
          select docId from documents
          where zone = 'zone2' and bookshelf = 'fiction'
          qualify row_number() over (partition by zone, bookshelf order by euclidean_square_distance(embedding, !! !v16 [0.0, 0.0, 1.0] !!) asc) < 2
      - explain: "ISCAN(DOCUMENTSEUCLIDEANSQUAREINDEX [EQUALS promote(@c8 AS STRING), EQUALS promote(@c12 AS STRING)]:{DISTANCE_RANK_LESS_THAN @c30: @c35}:[] BY_DISTANCE) | MAP (_.DOCID AS DOCID)"
      - result: [{'d11'}]
# Test dot_product_distance metric
    -
      - query:
          select docId, title, dot_product_distance(embedding, !! !v16 [1.0, 0.0, 0.0] !!) from documents
          where zone = 'zone1' and bookshelf = 'fiction'
          qualify row_number() over (partition by zone, bookshelf order by dot_product_distance(embedding, !! !v16 [1.0, 0.0, 0.0] !!) asc) <= 1
      - explain: "ISCAN(DOCUMENTSDOTPRODUCTINDEX [EQUALS promote(@c17 AS STRING), EQUALS promote(@c21 AS STRING)]:{DISTANCE_RANK_LESS_THAN_OR_EQUAL @c39: @c45}:[] BY_DISTANCE) | MAP (_.DOCID AS DOCID, _.TITLE AS TITLE, (_.EMBEDDING) dot_product_distance @c39 AS _2)"
      - result: [{'d1', 'The Great Gatsby', -1.0}]
    -
      - query:
          select docId, dot_product_distance(embedding, !! !v16 [1.0, 0.0, 0.0] !!) from documents
          where zone = 'zone1' and bookshelf = 'fiction'
          qualify row_number() over (partition by zone, bookshelf order by dot_product_distance(embedding, !! !v16 [1.0, 0.0, 0.0] !!) asc) <= 3
      - explain: "ISCAN(DOCUMENTSDOTPRODUCTINDEX [EQUALS promote(@c15 AS STRING), EQUALS promote(@c19 AS STRING)]:{DISTANCE_RANK_LESS_THAN_OR_EQUAL @c37: @c43}:[] BY_DISTANCE) | MAP (_.DOCID AS DOCID, (_.EMBEDDING) dot_product_distance @c37 AS _1)"
      - result: [{'d1', -1.0}, {'d2', -0.89990234375}, {'d3', -0.7998046875}]
    -
      - query:
          select docId from documents
          where zone = 'zone1' and bookshelf = 'science'
          qualify row_number() over (partition by zone, bookshelf order by dot_product_distance(embedding, !! !v16 [0.0, 1.0, 0.0] !!) asc options ef_search = 100) <= 2
      - explain: "ISCAN(DOCUMENTSDOTPRODUCTINDEX [EQUALS promote(@c8 AS STRING), EQUALS promote(@c12 AS STRING)]:{DISTANCE_RANK_LESS_THAN_OR_EQUAL @c30: @c40}:[hnswEfSearch: 100] BY_DISTANCE) | MAP (_.DOCID AS DOCID)"
      - result: [{'d6'}, {'d7'}]
    -
      - query:
          select docId from documents
          where zone = 'zone1' and bookshelf = 'science'
          qualify row_number() over (partition by zone, bookshelf order by dot_product_distance(embedding, !! !v16 [0.0, 1.0, 0.0] !!) asc options ef_search = 200) < 3
      - explain: "ISCAN(DOCUMENTSDOTPRODUCTINDEX [EQUALS promote(@c8 AS STRING), EQUALS promote(@c12 AS STRING)]:{DISTANCE_RANK_LESS_THAN @c30: @c39}:[hnswEfSearch: 200] BY_DISTANCE) | MAP (_.DOCID AS DOCID)"
      - result: [{'d6'}, {'d7'}]
    -
      - query:
          select docId from documents
          where zone = 'zone2' and bookshelf = 'fiction'
          qualify row_number() over (partition by zone, bookshelf order by dot_product_distance(embedding, !! !v16 [0.0, 0.0, 1.0] !!) asc) < 2
      - explain: "ISCAN(DOCUMENTSDOTPRODUCTINDEX [EQUALS promote(@c8 AS STRING), EQUALS promote(@c12 AS STRING)]:{DISTANCE_RANK_LESS_THAN @c30: @c35}:[] BY_DISTANCE) | MAP (_.DOCID AS DOCID)"
      - result: [{'d11'}]
# Test HNSW index with mixed-type partition columns (bigint and string)
    -
      - query:
          insert into multiTypePartitionDocs values
          (1, 'd1', 'fiction', 'The Great Gatsby', !! !v16 [1.0, 0.0, 0.0] !!),
          (1, 'd2', 'fiction', '1984', !! !v16 [0.9, 0.1, 0.0] !!),
          (1, 'd3', 'fiction', 'To Kill a Mockingbird', !! !v16 [0.8, 0.2, 0.0] !!),
          (1, 'd4', 'science', 'A Brief History of Time', !! !v16 [0.0, 1.0, 0.0] !!),
          (1, 'd5', 'science', 'Cosmos', !! !v16 [0.1, 0.9, 0.0] !!),
          (2, 'd6', 'fiction', 'Moby Dick', !! !v16 [0.0, 0.0, 1.0] !!),
          (2, 'd7', 'fiction', 'War and Peace', !! !v16 [0.0, 0.1, 0.9] !!),
          (2, 'd8', 'science', 'The Gene', !! !v16 [0.5, 0.5, 0.0] !!),
          (2, 'd9', 'science', 'Sapiens', !! !v16 [0.4, 0.4, 0.2] !!)
      - count: 9
    -
      - query:
          select docId from multiTypePartitionDocs
          where zoneId = 1 and bookshelf = 'fiction'
          qualify row_number() over (partition by zoneId, bookshelf order by euclidean_square_distance(embedding, !! !v16 [1.0, 0.0, 0.0] !!) asc) <= 2
      - explain: "ISCAN(MULTITYPEEUCLIDEANSQUAREINDEX [EQUALS promote(@c8 AS LONG), EQUALS promote(@c12 AS STRING)]:{DISTANCE_RANK_LESS_THAN_OR_EQUAL @c30: @c36}:[] BY_DISTANCE) | MAP (_.DOCID AS DOCID)"
      - result: [{'d1'}, {'d2'}]
    -
      - query:
          select docId from multiTypePartitionDocs
          where zoneId = 1 and bookshelf = 'science'
          qualify row_number() over (partition by zoneId, bookshelf order by euclidean_square_distance(embedding, !! !v16 [0.0, 1.0, 0.0] !!) asc) <= 2
      - explain: "ISCAN(MULTITYPEEUCLIDEANSQUAREINDEX [EQUALS promote(@c8 AS LONG), EQUALS promote(@c12 AS STRING)]:{DISTANCE_RANK_LESS_THAN_OR_EQUAL @c30: @c36}:[] BY_DISTANCE) | MAP (_.DOCID AS DOCID)"
      - result: [{'d4'}, {'d5'}]
    -
      - query:
          select docId, title from multiTypePartitionDocs
          where zoneId = !! 1 !! and bookshelf = 'fiction'
          qualify row_number() over (partition by zoneId, bookshelf order by dot_product_distance(embedding, !! !v16 [1.0, 0.0, 0.0] !!) asc) <= !! 2 !!
      - explain: "ISCAN(MULTITYPEDOTPRODUCTINDEX [EQUALS promote(@c10 AS LONG), EQUALS promote(@c14 AS STRING)]:{DISTANCE_RANK_LESS_THAN_OR_EQUAL @c32: @c38}:[] BY_DISTANCE) | MAP (_.DOCID AS DOCID, _.TITLE AS TITLE)"
      - result: [{'d1', 'The Great Gatsby'}, {'d2', '1984'}]
# verify supported and unsupported sort specifications within window function.
    -
      - query:
          select docId, title from multiTypePartitionDocs
          where zoneId = !! 2 !! and bookshelf = 'fiction'
          qualify row_number() over (partition by zoneId, bookshelf order by euclidean_square_distance(embedding, !! !v16 [0.0, 0.1, 0.9] !!) asc nulls first) <= !! 3 !!
      - explain: "ISCAN(MULTITYPEEUCLIDEANSQUAREINDEX [EQUALS promote(@c10 AS LONG), EQUALS promote(@c14 AS STRING)]:{DISTANCE_RANK_LESS_THAN_OR_EQUAL @c32: @c40}:[] BY_DISTANCE) | MAP (_.DOCID AS DOCID, _.TITLE AS TITLE)"
      - result: [{'d7', 'War and Peace'}, {'d6', 'Moby Dick'}]
    -
      - query:
          select docId, title from multiTypePartitionDocs
          where zoneId = !! 3 !! and bookshelf = 'fiction'
          qualify row_number() over (partition by zoneId, bookshelf order by dot_product_distance(embedding, !! !v16 [0.0, 0.1, 0.9] !!) desc) <= !! 2 !!
      - error: "0AF01"
    -
      - query:
          select docId, title from multiTypePartitionDocs
          where zoneId = !! 3 !! and bookshelf = 'fiction'
          qualify row_number() over (partition by zoneId, bookshelf order by dot_product_distance(embedding, !! !v16 [0.0, 0.1, 0.9] !!) desc nulls first) <= !! 2 !!
      - error: "0AF01"
    -
      - query:
          select docId, title from multiTypePartitionDocs
          where zoneId = !! 3 !! and bookshelf = 'fiction'
          qualify row_number() over (partition by zoneId, bookshelf order by dot_product_distance(embedding, !! !v16 [0.0, 0.1, 0.9] !!) desc nulls last) <= !! 2 !!
      - error: "0AF01"
    -
      - query:
          select docId, title from multiTypePartitionDocs
          where zoneId = !! 3 !! and bookshelf = 'fiction'
          qualify row_number() over (partition by zoneId, bookshelf order by dot_product_distance(embedding, !! !v16 [0.0, 0.1, 0.9] !!) nulls last) <= !! 2 !!
      - error: "0AF01"
