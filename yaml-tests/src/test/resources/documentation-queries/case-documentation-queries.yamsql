---
options:
  supported_version: 4.7.2.0
---
schema_template:
    create table products(id bigint, name string, category string, price bigint, stock integer, primary key(id))
    create index name_idx as select name from products order by name
    create index price_idx as select price from products order by price
    create index name_price_idx as select name, price from products order by name
---
setup:
  steps:
    - query: insert into products
            values (1, 'Widget A', 'Electronics', 100, 50),
                   (2, 'Widget B', 'Electronics', 150, 5),
                   (3, 'Gadget X', 'Electronics', 200, 0),
                   (4, 'Tool A', 'Hardware', 80, 100),
                   (5, 'Tool B', 'Hardware', 120, 15)
---
test_block:
  name: case-documentation-tests
  preset: single_repetition_ordered
  tests:
    # Searched CASE - Simple condition
    -
      - query: SELECT name,
                     stock,
                     CASE
                         WHEN stock = 0 THEN 'Out of Stock'
                         WHEN stock < 10 THEN 'Low Stock'
                         WHEN stock < 50 THEN 'In Stock'
                         ELSE 'Well Stocked'
                     END AS stock_status
              FROM products
              ORDER BY name
      - result: [{name: "Gadget X", stock: 0, stock_status: "Out of Stock"},
                 {name: "Tool A", stock: 100, stock_status: "Well Stocked"},
                 {name: "Tool B", stock: 15, stock_status: "In Stock"},
                 {name: "Widget A", stock: 50, stock_status: "Well Stocked"},
                 {name: "Widget B", stock: 5, stock_status: "Low Stock"}]

    # Simple CASE - Value matching
    -
      - query: SELECT name,
                     category,
                     CASE
                         WHEN category = 'Electronics' THEN 'E'
                         WHEN category = 'Hardware' THEN 'H'
                         WHEN category = 'Media' THEN 'M'
                         ELSE 'Other'
                     END AS category_code
              FROM products
              ORDER BY name
      - result: [{name: "Gadget X", category: "Electronics", category_code: "E"},
                 {name: "Tool A", category: "Hardware", category_code: "H"},
                 {name: "Tool B", category: "Hardware", category_code: "H"},
                 {name: "Widget A", category: "Electronics", category_code: "E"},
                 {name: "Widget B", category: "Electronics", category_code: "E"}]

    # Nested CASE
    -
      - query: SELECT name,
                     price,
                     stock,
                     CASE
                         WHEN stock = 0 THEN 'Unavailable'
                         ELSE CASE
                             WHEN price < 100 THEN 'Budget'
                             WHEN price < 150 THEN 'Standard'
                             ELSE 'Premium'
                         END
                     END AS product_tier
              FROM products
              ORDER BY name
      - result: [{name: "Gadget X", price: 200, stock: 0, product_tier: "Unavailable"},
                 {name: "Tool A", price: 80, stock: 100, product_tier: "Budget"},
                 {name: "Tool B", price: 120, stock: 15, product_tier: "Standard"},
                 {name: "Widget A", price: 100, stock: 50, product_tier: "Standard"},
                 {name: "Widget B", price: 150, stock: 5, product_tier: "Premium"}]
