---
options:
  supported_version: 4.3.2.0
---
schema_template:
    create table a(ida integer, x integer, primary key(ida))
    create index a_ida_idx as select ida from a order by ida
    create index a_x_idx as select x from a order by x
    create table x(idx integer, y integer, primary key(idx))
    create table b(idb integer, q integer, r integer, primary key(idb))
    create index ib as select q from b
    CREATE TYPE AS STRUCT s(f integer)
    create table r(idr integer, nr s array, primary key(idr))
    create index ir as select sq.f from r, (select f from r.nr) sq
---
setup:
  steps:
    - query: insert into a values (1, 1), (2, 2), (3, 3)
    - query: insert into x values (4, 10), (5, 20), (6, 30)
    - query: insert into b values (1, 10, 100), (2, 20, 200), (3, 30, 300)
    - query: insert into r values (1, [(11), (12), (13)]), (2, [(21), (22), (23)]), (3, [(31), (32), (33)])
---
test_block:
  name: subqueries-documentation-tests
  preset: single_repetition_ordered
  tests:
    # Non-Correlated EXISTS Subquery
    -
      - query: SELECT ida FROM a WHERE EXISTS (SELECT ida FROM a WHERE ida = 1)
      - supported_version: 4.3.2.0
      - unorderedResult: [{ida: 1}, {ida: 2}, {ida: 3}]

    # Correlated Subquery in FROM Clause
    -
      - query: SELECT x, sq.idr, sq.nr
              FROM a, (SELECT * FROM r WHERE r.idr = a.x) sq
      - supported_version: 4.3.2.0
      - unorderedResult: [{x: 1, idr: 1, nr: [{f: 11}, {f: 12}, {f: 13}]},
                          {x: 2, idr: 2, nr: [{f: 21}, {f: 22}, {f: 23}]},
                          {x: 3, idr: 3, nr: [{f: 31}, {f: 32}, {f: 33}]}]

    # Array Unnesting with PartiQL
    -
      - query: SELECT idr FROM r, r.nr AS NEST WHERE NEST.f = 23
      - supported_version: 4.3.2.0
      - result: [{idr: 2}]

    # Array Unnesting with Subquery
    -
      - query: SELECT idr FROM r, (SELECT * FROM r.nr) AS NEST WHERE NEST.f = 23
      - supported_version: 4.3.2.0
      - result: [{idr: 2}]

    # Correlated Subquery with GROUP BY
    -
      - query: SELECT x FROM a
              WHERE EXISTS (
                  SELECT a.x, MAX(idb) FROM b
                  WHERE q > a.x
                  GROUP BY q
              )
      - supported_version: 4.3.2.0
      - unorderedResult: [{x: 1}, {x: 2}, {x: 3}]

    # Correlation in Aggregation Functions
    -
      - query: SELECT x FROM a
              WHERE EXISTS (
                  SELECT MAX(a.x), MAX(idb) FROM b
                  WHERE q > x
                  GROUP BY q
              )
      - supported_version: 4.3.2.0
      - unorderedResult: [{x: 1}, {x: 2}, {x: 3}]
