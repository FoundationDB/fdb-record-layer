#
# with-included-dependencies.yamsql
#
# This source file is part of the FoundationDB open source project
#
# Copyright 2021-2025 Apple Inc. and the FoundationDB project authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
options:
  connection_options:
    CASE_SENSITIVE_IDENTIFIERS: true
---
setup:
  connect: "jdbc:embed:/__SYS?schema=CATALOG"
  steps:
    - query: drop schema template if exists WITH_INCLUDED_DEPENDENCIES_TEMPLATE
    - query: drop database if exists /FRL/WITH_INCLUDED_DEPENDENCIES_YAML
    - query: create database /FRL/WITH_INCLUDED_DEPENDENCIES_YAML
    - load schema template: WITH_INCLUDED_DEPENDENCIES_TEMPLATE from src/test/resources/import-schema-template/with_included_dependencies_metadata.json
    - query: create schema /FRL/WITH_INCLUDED_DEPENDENCIES_YAML/TEST with template WITH_INCLUDED_DEPENDENCIES_TEMPLATE
    - set schema state: "{\"name\": \"TEST\", \"database_id\": \"/FRL/WITH_INCLUDED_DEPENDENCIES_YAML\", \"template_name\": \"WITH_INCLUDED_DEPENDENCIES_TEMPLATE\", \"store_info\" : {\"formatVersion\": 2}}"
---
setup:
  connect: "jdbc:embed:/FRL/WITH_INCLUDED_DEPENDENCIES_YAML?schema=TEST"
  steps:
  - query: INSERT INTO T VALUES
             (1, (10, 'foo') ),
             (2, ( 9, 'bar') ),
             (3, ( 8, 'foo') ),
             (4, ( 7, 'bar') ),
             (5, ( 6, 'foo') )
  - query: INSERT INTO U VALUES
             (1, ( 5, 'foo') ),
             (2, ( 4, 'bar') ),
             (3, ( 3, 'foo') ),
             (4, ( 2, 'bar') ),
             (5, ( 1, 'foo') )
---
test_block:
  connect: "jdbc:embed:/FRL/WITH_INCLUDED_DEPENDENCIES_YAML?schema=TEST"
  name: with-included-dependencies
  tests:
    -
      - query: SELECT x.a, id FROM T WHERE x.b = 'foo' ORDER BY x.a ASC;
      - result: [
          { a:  6, id: 5 },
          { a:  8, id: 3 },
          { a: 10, id: 1 },
        ]
    -
      - query: SELECT x.a, id FROM U WHERE x.b = 'foo' ORDER BY x.a DESC;
      - result: [
          { a: 5, id: 1 },
          { a: 3, id: 3 },
          { a: 1, id: 5 },
        ]
