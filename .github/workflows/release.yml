name: Release

on:
  workflow_dispatch:

jobs:
  gradle:
    runs-on: ubuntu-latest
    permissions:
      checks: write
      contents: write
      packages: write
      pages: write
    steps:
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    - name: Checkout sources
      uses: actions/checkout@v4.2.2
    - name: Run Gradle Test
      uses: ./actions/gradle-test
      with:
        gradle_args: "-PreleaseBuild=true"

    # Always push a version bump back to main. There are failure scenarios that can result
    # in published artifacts but an erroneous build, and it's safer to have version gaps
    - name: Configure Git
      if: always()
      run: |
        git config --global user.name 'FoundationDB CI'
        git config --global user.email 'foundationdb_ci@apple.com'
    - name: Increment Version
      if: always()
      run: python build/increment_version.py gradle.properties --commit
    - name: Push Changes
      if: always()
      run: git push
