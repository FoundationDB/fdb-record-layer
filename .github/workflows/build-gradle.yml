name: Build Record Layer

on: push

env:
  FDB_VERSION: "7.3.42"

jobs:
  build-gradle:
    runs-on: ubuntu-latest
    steps:
    - name: Install FDB
      run: wget https://github.com/apple/foundationdb/releases/download/${FDB_VERSION}/foundationdb-clients_${FDB_VERSION}-1_amd64.deb
    - run: wget https://github.com/apple/foundationdb/releases/download/${FDB_VERSION}/foundationdb-server_${FDB_VERSION}-1_amd64.deb
    - run: sudo dpkg -i foundationdb-clients_${FDB_VERSION}-1_amd64.deb foundationdb-server_${FDB_VERSION}-1_amd64.deb
    - run: sudo sed -i -e "s/public_address = auto:\$ID/public_address = 127.0.0.1:\$ID/g" -e "s/listen_address = public/listen_address = 0.0.0.0:\$ID/g" /etc/foundationdb/foundationdb.conf
    - run: sudo /usr/lib/foundationdb/fdbmonitor /etc/foundationdb/foundationdb.conf --daemonize
    - run: fdbcli --exec "configure single ssd storage_migration_type=aggressive; status"
    - name: Checkout sources
      uses: actions/checkout@v4
    - run: sed -i -e "s/^org\.gradle\..*/#&/g" gradle.properties
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
    - name: Run build
      run: GRADLE_OPTS="-XX:+HeapDumpOnOutOfMemoryError -Xverify:none -XX:+TieredCompilation -Xmx4096m -Dfile.encoding=UTF-8 -Duser.country -Duser.language=en -Duser.variant --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.lang.invoke=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.prefs/java.util.prefs=ALL-UNNAMED" ./gradlew --no-daemon --console=plain -b ./build.gradle build destructiveTest -PcoreNotStrict -PreleaseBuild=false -PpublishBuild=false -PspotbugsEnableHtmlReport
    - run: mkdir -p test-reports && for d in fdb-java-annotations fdb-extensions fdb-record-layer-core fdb-record-layer-icu fdb-record-layer-spatial fdb-record-layer-lucene fdb-record-layer-jmh examples fdb-relational-api fdb-relational-core fdb-relational-cli fdb-relational-grpc fdb-relational-jdbc fdb-relational-server yaml-tests; do ln -s ../$d/.out/reports test-reports/$d; done
    - name: Publish Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          test-reports/fdb-java-annotations/
          test-reports/fdb-extensions/
          test-reports/fdb-record-layer-core/
          test-reports/fdb-record-layer-icu/
          test-reports/fdb-record-layer-spatial/
          test-reports/fdb-record-layer-lucene/
          test-reports/fdb-record-layer-jmh/
          test-reports/examples/
          test-reports/fdb-relational-api/
          test-reports/fdb-relational-core/
          test-reports/fdb-relational-cli/
          test-reports/fdb-relational-grpc/
          test-reports/fdb-relational-jdbc/
          test-reports/fdb-relational-server/
          test-reports/yaml-tests/
    - name: Test Summary
      if: always()
      uses: test-summary/action@v2
      with:
        paths: |
          fdb-java-annotations/.out/test-results/**/TEST-*.xml
          fdb-extensions/.out/test-results/**/TEST-*.xml
          fdb-record-layer-core/.out/test-results/**/TEST-*.xml
          fdb-record-layer-icu/.out/test-results/**/TEST-*.xml
          fdb-record-layer-spatial/.out/test-results/**/TEST-*.xml
          fdb-record-layer-lucene/.out/test-results/**/TEST-*.xml
          fdb-record-layer-jmh/.out/test-results/**/TEST-*.xml
          examples/.out/test-results/**/TEST-*.xml
          fdb-relational-api/.out/test-results/**/TEST-*.xml
          fdb-relational-core/.out/test-results/**/TEST-*.xml
          fdb-relational-cli/.out/test-results/**/TEST-*.xml
          fdb-relational-grpc/.out/test-results/**/TEST-*.xml
          fdb-relational-jdbc/.out/test-results/**/TEST-*.xml
          fdb-relational-server/.out/test-results/**/TEST-*.xml
          yaml-tests/.out/test-results/**/TEST-*.xml
